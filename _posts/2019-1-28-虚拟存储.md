---
layout: post
title: "虚拟存储概念"
date: 2019-1-28
excerpt: ""
tags: [操作系统，虚拟存储概念]
comments: true
---

## 动机

- 增长迅速的存储需求

## 基本概念

- 思路
  - 将不常用的部分内存块暂存到外存

- 原理：

  - 装载程序时
    - **只将当前指令执行需要的部分页面或断装入内存**

  - 指令执行中需要的指令或数据不在内存（称为缺页）
    - **处理器通知操作系统将相应的页面或断调入内存**

  - 操作系统将内存中暂时不用的页面或段保存到外存

- 实现方式
  - 虚拟页式
  - 虚拟段式

## 基本特征

- 不连续性
  - 物理内存分配非连续
  - 虚拟地址空间使用非连续

- 大用户空间
  - 提供给用户的虚拟内存可大于实际的物理内存

- 部分交换
  - 虚拟存储只对部分虚拟地址空间进行调入和调出

## 技术支持

- 硬件
  - 页式或短时存储中的地址转换机制

- 操作系统
  - 管理内存和外存间页面或断的换入和换出

## 虚拟页式存储管理

- 在页式存储管理的基础上，增加请求调页和页面置换

- 思路

  - 当用户程序要装载到内存运行时，只装入部分页面，就启动程序运行

  - 进程在运行中发现有需要的代码或数据不在内存中时，则向系统发出缺页异常请求

  - 操作系统在处理缺页异常时，将外存中相应的页面调入内存中使得进程能继续运行

## 缺页异常

- ![](../assets/img/缺页中断处理流程.png)

- 如何保存未被映射的页？
  - 交换空间（Unix）

- 虚拟页式存储的外存选择
  - 代码段：可执行二进制空间
  - 动态加载的共享库程序段：动态调用
  - 其他段：交换空间

##　页面置换算法的概念

- 功能
  - 当出现缺页异常，需调入新页面而内存已满时，置换算法**选择被置换的物理页面**

- 设计目标
  - 尽可能减少页面的调入调出次数
  - 把未来不再访问或短期内不访问的页面调出

- 页面锁定
  - 描述必须常驻内存的逻辑页面
  - 操作系统的关键部分
  - 要求相应速度的代码和数据
  - 页表中的锁定标志位

##　最优页面置换算法

- 基本思路
  - 置换在未来最长时间不访问的页面

- 算法实现
  - 缺页时，计算内存中每个逻辑页面的下一次访问时间
  - 选择未来最长时间不访问的页面

- 算法特征

  - 缺页最少，理想情况
  - 实际系统中无法实现
  - 无法预知每个页面在下次访问前的等待时间

  - 作为置换算法的性能评价依据

##　先进先出算法

- 思路
  - 选择在**内存驻留时间最长的页面**继续置换

- 实现
  - 维护一个记录所有位于内存中的逻辑页面链表
  - 链表元素按驻留内存的时间排序，链首最长，链尾最短
  - 出现缺页时，选择链首页面继续置换，新页面加到链尾

- 特征

  - 实现简单
  - 性能较差，调出的页面可能是经常访问的
  - 进程分配物理页面数增加时，缺页并不会减少
  - 很少单独使用

  ![](../assets/img/fifo.png)

##　最近最久未使用算法（LRU）

- 思路
  - 选择最长时间没有被引用的页面进行置换
  - 如某些页面长时间未被访问 ，则他们将来还可能会长时间不会访问

- 实现
  - 缺页时，计算内存中每个逻辑页面的上一次访问时间
  - 选择上一次使用到当前时间最长的页面

![](../assets/img/Lru.png)

- LRU算法可能实现的方法

  - 页面链表

    - 系统维护一个按最近一次访问时间排序的页面链表
      - 链首节点是最近刚刚使用过的页面
      - 链表尾节点是最久未使用的页面

    - 访问内存时，找到相应页面，并把他移到链首之首